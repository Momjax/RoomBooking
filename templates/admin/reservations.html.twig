{% extends 'base.html.twig' %}
{% block title %}Gestion des R√©servations - Admin{% endblock %}
{% block stylesheets %}
<style>
    .table-container { background: #1e293b; border-radius: 16px; overflow: hidden; border: 1px solid #334155; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #334155; color: #94a3b8; padding: 1rem; text-align: left; font-size: 0.85rem; }
    td { padding: 1rem; border-bottom: 1px solid #1e293b; color: #e2e8f0; vertical-align: middle; }
    .status-badge { padding: 0.3rem 0.6rem; border-radius: 20px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
    .btn-action { border: none; padding: 0.5rem 0.8rem; border-radius: 8px; cursor: pointer; font-size: 0.75rem; font-weight: 700; transition: opacity 0.2s; text-decoration: none; }
    .btn-cancel { background: #f59e0b; color: #0f172a; }
    .btn-delete { background: #ef4444; color: white; }
    .btn-action:hover { opacity: 0.8; }
</style>
{% endblock %}
{% block body %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h1>üõ°Ô∏è Gestion globale des r√©servations</h1>
    <span style="color: #64748b; font-size: 0.9rem;">{{ reservations|length }} entr√©e(s) trouv√©e(s)</span>
</div>

<div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 1.2rem; margin-bottom: 2rem;">
    <form method="get" style="display: flex; gap: 1rem; align-items: flex-end;">
        <div style="flex: 1;">
            <label style="display: block; color: #94a3b8; font-size: 0.75rem; margin-bottom: 0.4rem;">Filtrer par salle</label>
            <select name="room" style="width: 100%; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; padding: 0.5rem;">
                <option value="">Toutes les salles</option>
                {% for room in rooms %}
                    <option value="{{ room.id }}" {{ selectedRoom == room.id ? 'selected' : '' }}>{{ room.nomSalle }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="flex: 1;">
            <label style="display: block; color: #94a3b8; font-size: 0.75rem; margin-bottom: 0.4rem;">Filtrer par utilisateur</label>
            <select name="user" style="width: 100%; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; padding: 0.5rem;">
                <option value="">Tous les utilisateurs</option>
                {% for user in users %}
                    <option value="{{ user.id }}" {{ selectedUser == user.id ? 'selected' : '' }}>{{ user.fullName }} ({{ user.email }})</option>
                {% endfor %}
            </select>
        </div>
        <div style="flex: 1;">
            <label style="display: block; color: #94a3b8; font-size: 0.75rem; margin-bottom: 0.4rem;">Filtrer par date</label>
            <input type="date" name="date" value="{{ selectedDate }}" style="width: 100%; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; padding: 0.5rem;">
        </div>
        <div style="flex: 1;">
            <label style="display: block; color: #94a3b8; font-size: 0.75rem; margin-bottom: 0.4rem;">Ordre chronologique</label>
            <select name="order" style="width: 100%; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; padding: 0.5rem;">
                <option value="DESC" {{ selectedOrder == 'DESC' ? 'selected' : '' }}>Plus r√©cent d'abord</option>
                <option value="ASC" {{ selectedOrder == 'ASC' ? 'selected' : '' }}>Plus ancien d'abord</option>
            </select>
        </div>
        <button type="submit" style="background: #38bdf8; color: #0f172a; border: none; padding: 0.6rem 1.5rem; border-radius: 8px; font-weight: 700; cursor: pointer;">Filtrer</button>
        <a href="{{ path('app_admin_reservations') }}" style="color: #64748b; text-decoration: none; font-size: 0.85rem; padding-bottom: 0.6rem;">R√©initialiser</a>
    </form>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Salle</th>
                <th>Utilisateur</th>
                <th>Date / Heure</th>
                <th>Statut</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for res in reservations %}
                {% set computedStatus = res.computedStatus %}
                <tr>
                    <td><strong>{{ res.room.nomSalle }}</strong></td>
                    <td>{{ res.utilisateur.fullName }}<br><small style="color:#64748b">{{ res.utilisateur.email }}</small></td>
                    <td>
                        <span style="color: #38bdf8;">{{ res.reservationStart|date('d/m/Y') }}</span><br>
                        <small>{{ res.reservationStart|date('H:i') }} - {{ res.reservationEnd|date('H:i') }}</small>
                    </td>
                    <td>
                        {% if computedStatus == 'ANNUL√â' %}
                            <span class="status-badge" style="background: rgba(239, 68, 68, 0.15); color: #ef4444;">ANNUL√â</span>
                        {% elseif computedStatus == 'TERMIN√â' %}
                            <span class="status-badge" style="background: rgba(148, 163, 184, 0.1); color: #94a3b8;">TERMIN√â</span>
                        {% else %}
                            <span class="status-badge" style="background: rgba(56, 189, 248, 0.15); color: #38bdf8;">VALID√â</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            {% if computedStatus == 'VALID√â' %}
                                <form method="post" action="{{ path('app_admin_reservation_cancel', {id: res.id}) }}" onsubmit="return confirm('Annuler cette r√©servation ?')">
                                    <button class="btn-action btn-cancel">Annuler</button>
                                </form>
                            {% endif %}
                            
                            {% if computedStatus == 'ANNUL√â' %}
                                <form method="post" action="{{ path('app_admin_reservation_delete', {id: res.id}) }}" onsubmit="return confirm('SUPPRIMER D√âFINITIVEMENT de la base de donn√©es ? Cette action est irr√©versible.')">
                                    <button class="btn-action btn-delete">Supprimer (BDD)</button>
                                </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="5" style="text-align: center; padding: 3rem; color: #64748b;">Aucune r√©servation dans le syst√®me.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
